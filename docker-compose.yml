version: '3.8'

services:
  redis:
    image: redis:7-alpine
    ports: ['6379:6379']
    volumes: [redis_data:/data]
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 3

  searxng:
    image: searxng/searxng:latest
    ports: ['8080:8080']
    environment: [SEARXNG_BASE_URL=http://localhost:8080]
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8080']
      interval: 30s
      timeout: 10s
      retries: 5

  qdrant:
    image: qdrant/qdrant:latest
    ports: ['6333:6333']
    volumes: [qdrant_data:/qdrant/storage]
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:6333/health']
      interval: 30s
      timeout: 10s
      retries: 5

  phi3:
    image: ghcr.io/ggerganov/llama.cpp:server
    ports: ['8082:8082']
    environment: [MODEL=phi-3-mini-4k.gguf]
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8082/health']
      interval: 60s
      timeout: 30s
      retries: 10

  streamlit-ui:
    image: python:3.11-slim
    ports: ['8501:8501']
    volumes:
      - ./src:/app/src
      - ./.env:/app/.env
    working_dir: /app
    command: bash -c "pip install --no-cache-dir streamlit redis requests && streamlit run src/web/app.py --server.address 0.0.0.0 --server.port 8501"
    depends_on:
      redis:
        condition: service_healthy
      phi3:
        condition: service_healthy
    restart: unless-stopped

volumes:
  redis_data:
  qdrant_data:
