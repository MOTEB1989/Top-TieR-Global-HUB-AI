#!/bin/bash
# Complete Build and Test Script
# ุณูุฑุจุช ุจูุงุก ูุงุฎุชุจุงุฑ ุดุงูู

set -e

echo "=========================================="
echo "๐ ุจูุงุก ูุงุฎุชุจุงุฑ ุงููุดุฑูุน ุงูุดุงูู"
echo "=========================================="
echo ""

# ========================================
# 1. ุชูุธูู ุงููููุงุช ุงูููุฑุฑุฉ
# ========================================
echo "๐งน ุชูุธูู ุงููููุงุช ุงูููุฑุฑุฉ..."
rm -f src/ai.ts src/openai.ts 2>/dev/null || true
echo "โ ุชู ุงูุชูุธูู"
echo ""

# ========================================
# 2. ุนุฑุถ ุงูุจููุฉ
# ========================================
echo "๐ ุจููุฉ ุงููุดุฑูุน:"
echo "src/"
tree -L 2 src/ 2>/dev/null || ls -R src/
echo ""

# ========================================
# 3. ุงุฎุชุจุงุฑ ุจูุงุก TypeScript
# ========================================
echo "๐ฆ ุงุฎุชุจุงุฑ ุจูุงุก TypeScript..."
if npm run build; then
    echo "โ ุจูุงุก TypeScript ูุฌุญ!"
    echo ""
    echo "๐ ุงููููุงุช ุงููุจููุฉ:"
    ls -lh dist/ 2>/dev/null || echo "ูุฌูุฏ dist ุบูุฑ ููุฌูุฏ"
else
    echo "โ ุจูุงุก TypeScript ูุดู"
    exit 1
fi
echo ""

# ========================================
# 4. ุงุฎุชุจุงุฑ ุจูุงุก Docker
# ========================================
echo "๐ณ ุงุฎุชุจุงุฑ ุจูุงุก Docker..."
if docker build -t lexcode-api-test . 2>&1 | tail -20; then
    echo "โ ุจูุงุก Docker ูุฌุญ!"
    
    echo ""
    echo "๐ ูุนูููุงุช ุงูุตูุฑุฉ:"
    docker images lexcode-api-test
else
    echo "โ ุจูุงุก Docker ูุดู"
    exit 1
fi
echo ""

# ========================================
# 5. ุงุฎุชุจุงุฑ Telegram Bot
# ========================================
echo "๐ค ุงุฎุชุจุงุฑ Telegram Bot..."
if python3 scripts/test_telegram_bot.py; then
    echo "โ Telegram Bot ุฌุงูุฒ!"
else
    echo "โ๏ธ  Telegram Bot ูุญุชุงุฌ ุฅุนุฏุงุฏ (TELEGRAM_BOT_TOKEN)"
fi
echo ""

# ========================================
# 6. ุงูููุฎุต ุงูููุงุฆู
# ========================================
echo "=========================================="
echo "๐ ููุฎุต ุงููุชุงุฆุฌ"
echo "=========================================="
echo "โ ุงูุจููุฉ ููุธูุฉ"
echo "โ TypeScript ูุจูู ุจูุฌุงุญ"
echo "โ Docker ูุจูู ุจูุฌุงุญ"
echo "โ๏ธ  Telegram Bot ูุญุชุงุฌ ููุงุชูุญ"
echo ""
echo "๐ฏ ุงูุฎุทูุงุช ุงูุชุงููุฉ:"
echo "1. ุฃุถู ููุงุชูุญ API ูู .env"
echo "2. ุดุบูู ุงูุฎุฏูุงุช: docker-compose up -d"
echo "3. ุงุฎุชุจุฑ ุงูู API: curl http://localhost:3000/health"
echo ""
echo "=========================================="
echo "โ ุงูุงุฎุชุจุงุฑ ุงูุชูู ุจูุฌุงุญ!"
echo "=========================================="
