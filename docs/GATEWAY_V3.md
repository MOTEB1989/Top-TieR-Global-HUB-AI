# AI Gateway V3 – Documentation

## 1. Overview
شرح مختصر لما يقدمه Gateway V3:
- Multi-provider (OpenAI / Groq / Azure / Local)
- Multi-task auto-detection
- Multi-file-type support
- Unified Markdown output for CI/PR comments
- Integration with ai_prompts/

## 2. Features
قائمة منظمة:
- كشف تلقائي للتخصصات
- دعم الملفات: txt, md, py, rs, js, ts, yaml, yml, docx, pdf
- قراءة ذكية للملفات (smart loader)
- تحليل متعدد التخصصات داخل نفس الملف
- تصميم قابل لتوسعة نماذج جديدة

## 3. Directory Structure
- `docs/` → وثائق معمارية وتشغيلية، بما فيها هذا الملف وملفات مرجعية أخرى.
- `ai_prompts/` → حزم القوالب النصية الخاصة بالمهام (coding, security, docs) مع دليل لكل مزود؛ يضاف عند استيراد الحزم.
- `providers.py` و `gpt_client.py` → نقاط الربط الأولية مع مقدمي النماذج وحلول العميل القياسية.
- `utils/` → أدوات مساعدة للتحميل الذكي، إدارة الملفات، والتحقق من الصيغ.
- `app/` و `api_server/` → طبقة الخدمات والـ API التي تستدعي البوابة وتنسق المهام متعددة النماذج.
- `policies/` و `SECURITY*.md` → سياسات الحوكمة والأمان التي يطبقها Gateway V3 قبل تمرير المخرجات.

## 4. Processing Flow
1) **Input discovery**: فحص المسارات المدخلة وتحديد أنواع الملفات المدعومة، مع رفض غير المعروف أو تجاوز الملفات الكبيرة آليًا.
2) **Task detection**: تحليل المحتوى لاستخراج نوع العمل (شرح، مراجعة أمنية، توثيق، كتابة اختبارات) لكل ملف.
3) **Prompt assembly**: دمج السياق العام مع قوالب `ai_prompts/` وبيانات الملف لإعداد طلب موحّد لكل مهمة.
4) **Provider routing**: اختيار المزود/الموديل الأنسب حسب التخصص، الحدود السعرية، وسياسات الأمان.
5) **Multi-disciplinary reasoning**: تمكين أكثر من تخصص داخل نفس الملف (مثلاً، مراجعة أمنية + تحسين أداء).
6) **Output harmonization**: إعادة تنسيق النتائج إلى Markdown موحد مع أقسام واضحة للاستعمال في CI أو تعليقات PR.
7) **Post-processing & policies**: تطبيق فلاتر الحوكمة، إزالة البيانات الحساسة، ثم تسليم الخرج إلى القناة المطلوبة.

## 5. Providers & Models
- **OpenAI**: نماذج عامة للتحليل متعدد الأغراض، مع دعم تعليمات النظام المركبة.
- **Groq**: للاستجابات السريعة منخفضة الكمون في مهام القراءة/التحليل الخفيفة.
- **Azure**: استخدام لنماذج متوافقة مع سياسات المؤسسة وتخزين إقليمي للبيانات.
- **Local**: نماذج ذاتية الاستضافة للاستخدام في البيئات المعزولة أو الحساسة.
- يمكن إضافة مزود جديد عبر تهيئة عميل في `providers.py` وتوفير إعدادات الاتصال في متغيرات البيئة أو ملفات الإعداد.

## 6. Task Auto-Detection
- يعتمد على إشارات من الامتداد، التعليقات داخل الملف، والكلمات المفتاحية (مثل TODO, SECURITY, TEST).
- يستخدم درجات ثقة لكل تخصص؛ إذا تجاوزت العتبة يتم توليد مهمة مخصصة.
- عند وجود أكثر من تخصص، يتم ترتيبها حسب الأولوية (الأمن → الاعتمادية → التوثيق → تحسين الأداء).

## 7. Smart File Loading
- يدعم ملفات النصوص وملفات الباينري (docx, pdf) عبر محولات متخصصة.
- يطبق حدود حجم افتراضية (مثلاً 1MB للنصوص، 10MB للـ PDF) مع تجزئة المحتوى عند الحاجة.
- يحافظ على ترميز UTF-8، ويضيف ملخصات مقتضبة للملفات الكبيرة لتقليل التكلفة.

## 8. Output Format
- كل مهمة ترجع كتلة Markdown تحتوي على: عنوان واضح، ملخص قصير، تفاصيل منظمة، وتوصيات قابلة للتنفيذ.
- الخرج مصمم ليعمل مباشرة داخل تعليقات PR أو تقارير CI مع أقسام قابلة للطي.
- يتضمن قائمة الملفات المتأثرة وروابط إلى الأسطر عند توفرها.

## 9. Extensibility Guidelines
- أضف تخصصًا جديدًا عبر تعريف قالب في `ai_prompts/` وتحديث مصفوفة الاكتشاف لدعمه.
- لدعم نوع ملف إضافي، وفر Loader جديد ضمن `utils/` مع تحويل موحد إلى نص وبيانات وصفية.
- عند إدراج مزود جديد، التزم بواجهة العميل الموحدة (connect, infer, stream) لضمان التوافق مع المسار الحالي.

## 10. Operational Notes
- يحتفظ Gateway V3 بسجلات الطلبات/الاستجابات مع التنقيح التلقائي للحقول الحساسة.
- يمكن تفعيل وضع dry-run لعرض المسار المختار والموجه دون إرسال الطلب للنموذج.
- يوصى بدمج اختبارات الدخان لكل مزود في CI للتأكد من صلاحية المفاتيح وامتثال السياسات.
