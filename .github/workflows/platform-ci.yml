name: Platform CI (Health + API Audit + Allowlist)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

permissions:
  contents: read

env:
  # ØºÙŠÙ‘Ø±Ù‡Ø§ Ø¥Ù„Ù‰ "false" Ù„Ùˆ ØªØ¨ØºÙ‰ Ø§Ù„ØµØ­Ø© ØªØ¸Ù‡Ø± Ø®Ø¶Ø±Ø§Ø¡ Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ (Ù„Ø§ ÙŠÙÙØ´Ù„ Ø§Ù„Ù€ CI)
  STRICT_HEALTHCHECK: "true"

jobs:
  platform-ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests jsonschema

      # 1) Healthcheck Ø¹Ù„Ù‰ Ø¨ÙˆØ§Ø¨Ø© Codex (Ø£Ø®Ø¶Ø±/Ø£Ø­Ù…Ø± Ø­Ø³Ø¨ STRICT_HEALTHCHECK)
      - name: Codex Healthcheck
        env:
          CODEX_API_KEY: ${{ secrets.CODEX_API_KEY }}
          STRICT: ${{ env.STRICT_HEALTHCHECK }}
        run: |
          set -e
          URL="https://api.lexcode.ai/v1/lex/run"
          STATUS=$(curl -s -o /tmp/resp.json -w "%{http_code}" \
            -H "Authorization: Bearer ${CODEX_API_KEY}" \
            -H "User-Agent: platform-ci-health" \
            -F "task=heartbeat" \
            "$URL" || true)
          echo "HTTP: $STATUS"
          echo "Response:" && cat /tmp/resp.json || true

          if [ "$STRICT" = "true" ]; then
            if [ "$STATUS" -lt 200 ] || [ "$STATUS" -ge 300 ]; then
              echo "Codex endpoint not healthy -> failing as STRICT=true"
              exit 1
            fi
          else
            echo "STRICT=false -> Ù„Ù† Ù†ÙØ´Ù„ Ø§Ù„Ù€ CI Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„."
          fi

      # 2) ØªØ´Ø®ÙŠØµ Ø§Ù„Ø¨ÙŠØ¦Ø© (ÙŠØ³ØªØ®Ø¯Ù… diagnose_env.py Ø¥Ù† ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§Ø› ÙˆØ¥Ù„Ø§ Ù†ÙƒØªØ¨ Ù†Ø³Ø®Ø© Ø®ÙÙŠÙØ©)
      - name: Diagnose environment
        env:
          GIT_TOKEN: ${{ secrets.GIT_TOKEN }}
          CODEX_API_KEY: ${{ secrets.CODEX_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ -f "diagnose_env.py" ]; then
            python diagnose_env.py
          else
            cat > diagnose_env.py << 'PY'
import os, requests
EXPECTED_SECRETS=["GIT_TOKEN","CODEX_API_KEY","OPENAI_API_KEY"]
CHECK_ENDPOINTS={"codex":"https://api.lexcode.ai/v1/lex/run","github":"https://api.github.com","openai":"https://api.openai.com/v1/models"}
missing=[]
print("ğŸ” ÙØ­Øµ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦ÙŠØ©:")
for v in EXPECTED_SECRETS:
    if os.getenv(v): print(f"âœ… {v} Ù…ÙˆØ¬ÙˆØ¯")
    else: print(f"âš ï¸  {v} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"); missing.append(v)
print("\nğŸŒ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª:")
for name,url in CHECK_ENDPOINTS.items():
    try:
        r=requests.get(url,timeout=5); c=r.status_code
        print(f"{'âœ…' if 200<=c<400 else 'âš ï¸ '} {name} ({c})")
    except Exception as e:
        print(f"âŒ {name} ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: {e}")
if missing:
    print("\nğŸš« Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©:"); [print(" -",m) for m in missing]
else:
    print("\nâœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø±Ø§Ø± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù…ØªÙˆÙÙ‘Ø±Ø©.")
PY
            python diagnose_env.py
          fi

      # 3) ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ù€ APIs (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø³ÙƒØ±Ø¨ØªÙƒ codex_api_audit.py) + Ø¥Ø±Ø³Ø§Ù„ Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ø¥Ù„Ù‰ Codex
      - name: Run API audit
        env:
          GIT_TOKEN: ${{ secrets.GIT_TOKEN }}
          CODEX_API_KEY: ${{ secrets.CODEX_API_KEY }}
        run: |
          if [ -f "codex_api_audit.py" ]; then
            if [ -n "${CODEX_API_KEY}" ]; then
              python codex_api_audit.py --repo-path . --output api_audit_report.json --send-to-codex
            else
              python codex_api_audit.py --repo-path . --output api_audit_report.json
            fi
          else
            echo "âŒ codex_api_audit.py ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹."
            exit 1
          fi
          test -f api_audit_report.json && jq '.apis_by_domain | length as $n | "âœ… API domains found: \($n)"' api_audit_report.json | sed 's/"//g' || true

      # 4) Ø¥Ø¹Ø¯Ø§Ø¯/ØªÙˆÙÙŠØ± Ù…Ù„ÙØ§Øª Ø§Ù„Ø³ÙŠØ§Ø³Ø©: allowlist + catalog (Ø¥Ù† Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©)
      - name: Ensure policy files exist
        run: |
          mkdir -p security
          if [ ! -f security/api-allowlist.json ]; then
            cat > security/api-allowlist.json << 'JSON'
{
  "allowed_domains": [
    "api.lexcode.ai",
    "api.openai.com",
    "api.github.com",
    "github.com"
  ]
}
JSON
          fi
          if [ ! -f security/api_catalog.yml ]; then
            cat > security/api_catalog.yml << 'YML'
apis:
  - domain: api.lexcode.ai
    label: Codex Gateway
    purpose: ÙØ­Øµ/Ø§Ø³ØªÙ„Ø§Ù… Ø£Ø±Ø´ÙŠÙØ§Øª ÙˆØªÙ‚Ø§Ø±ÙŠØ±
    auth: Bearer ${CODEX_API_KEY}
    owner: Platform

  - domain: api.openai.com
    label: OpenAI API
    purpose: Ù†Ù…Ø§Ø°Ø¬ Ù…Ø­Ø§Ø¯Ø«Ø©/ØªØ¶Ù…ÙŠÙ†
    auth: Bearer ${OPENAI_API_KEY}
    owner: AI

  - domain: api.github.com
    label: GitHub API
    purpose: ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ø£Ø±Ø´ÙŠÙ ÙˆØ§Ù„Ù…ÙŠØªØ§Ø¯Ø§ØªØ§
    auth: token ${GIT_TOKEN}
    owner: DevOps
YML
          fi
          echo "---- API Catalog ----"
          cat security/api_catalog.yml

      # 5) ÙØ±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§
      - name: Enforce API allowlist
        run: |
          python - << 'PY'
import json,sys
allow = json.load(open("security/api-allowlist.json"))["allowed_domains"]
report = json.load(open("api_audit_report.json"))
found = {item["domain"] for item in report.get("apis_by_domain", [])}
extras = sorted(d for d in found if d not in allow)
if extras:
    print("âŒ External APIs not on allowlist:")
    for d in extras: print(" -", d)
    sys.exit(1)
print("âœ… All external APIs are on the allowlist.")
PY

      # 6) (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ØªØ­Ù‚Ù‘Ù‚ Ù…Ø®Ø·Ø· JSON Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø§Ø³ØªØ®Ù„Ø§Øµ Ø¥Ù† ÙˆÙØ¬Ø¯ schema ÙˆÙ…Ù„ÙØ§Øª
      - name: Validate ingestion schema (optional)
        if: ${{ hashFiles('schemas/ingestion_record.schema.json') != '' }}
        run: |
          python - << 'PY'
import os, json, glob, sys
from jsonschema import validate, ValidationError
schema_path="schemas/ingestion_record.schema.json"
if not os.path.exists(schema_path):
    print("No schema file found; skipping."); sys.exit(0)
schema=json.load(open(schema_path))
errors=0
for path in glob.glob("**/*.jsonl", recursive=True):
    for i,line in enumerate(open(path,encoding="utf-8")):
        if not line.strip(): continue
        try:
            validate(instance=json.loads(line), schema=schema)
        except ValidationError as e:
            print(f"âŒ {path}:{i+1} -> {e.message}")
            errors+=1
if errors:
    print(f"Total schema errors: {errors}"); sys.exit(1)
print("âœ… JSONL matches schema.")
PY

      # 7) Ø±ÙØ¹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙƒÙ€ artifact
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: platform-ci-artifacts
          path: |
            api_audit_report.json
            security/api-allowlist.json
            security/api_catalog.yml
          if-no-files-found: warn
