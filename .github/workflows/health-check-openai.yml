name: Health Check OpenAI

on:
  schedule:
    - cron: "0 6 * * *"   # ‚è∞ ŸÉŸÑ ŸäŸàŸÖ ÿßŸÑÿ≥ÿßÿπÿ© 6 ÿµÿ®ÿßÿ≠ÿßŸã UTC
  workflow_dispatch:        # ‚úÖ ÿ™ÿ¥ÿ∫ŸäŸÑ ŸäÿØŸàŸä ŸÖŸÜ GitHub

permissions:
  contents: read

concurrency:
  group: health-check-openai
  cancel-in-progress: false

jobs:
  health-check:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      # ÿ∫ŸäŸëÿ± Ÿáÿ∞ÿß ÿ•ŸÑŸâ ÿ±ÿßÿ®ÿ∑ ŸÜŸÇÿ∑ÿ© ÿßŸÑŸÜŸáÿßŸäÿ© ÿßŸÑÿÆÿßÿ±ÿ¨Ÿäÿ© ŸÑÿØŸäŸÉ (ÿ•ŸÜ ŸÑŸÖ ŸäŸÉŸÜ ŸÑÿØŸäŸÉ ŸÜŸÇÿ∑ÿ© ŸÜŸáÿßŸäÿ©ÿå ÿßÿ™ÿ±ŸÉŸá ŸÉŸÖÿß ŸáŸà Ÿàÿ≥ŸäŸèÿπÿ™ÿ®ÿ± ÿßŸÑŸÅÿ≠ÿµ ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä ŸÅÿßÿ¥ŸÑÿßŸã/ŸÖÿ™ÿ¨ÿßŸàÿ≤ÿßŸã)
      EXTERNAL_URL: https://your-deployed-app-url/check-key

    steps:
      - name: üõ†Ô∏è Checkout Repository
        uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: üì¶ Install dependencies (if requirements.txt exists)
        if: hashFiles('requirements.txt') != ''
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ‚úÖ Internal check with gpt_client.py
        id: internal
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ ! -f "gpt_client.py" ]; then
            echo "gpt_client.py not found"
            echo "INTERNAL_FAILED=true" >> "$GITHUB_ENV"
            exit 0
          fi
          python gpt_client.py || { echo "INTERNAL_FAILED=true" >> "$GITHUB_ENV"; exit 0; }

      - name: üåç External check with deployed endpoint
        id: external
        run: |
          if [ -z "${{ env.EXTERNAL_URL }}" ]; then
            echo "No EXTERNAL_URL set, skipping external check"
            echo "EXTERNAL_FAILED=true" >> "$GITHUB_ENV"
            exit 0
          fi
          curl -fsS "${{ env.EXTERNAL_URL }}" >/dev/null || echo "EXTERNAL_FAILED=true" >> "$GITHUB_ENV"

      - name: üìù Job summary
        run: |
          {
            echo "## Health Check Summary"
            echo ""
            echo "- Internal failed: ${INTERNAL_FAILED:-false}"
            echo "- External failed: ${EXTERNAL_FAILED:-false}"
            echo ""
            echo "Repo: $GITHUB_REPOSITORY"
            echo "Run: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: üîî Send Alert if failed
        if: env.INTERNAL_FAILED == 'true' || env.EXTERNAL_FAILED == 'true'
        env:
          WEBHOOK_URL: ${{ secrets.ALERT_WEBHOOK_URL }}
        run: |
          if [ -z "$WEBHOOK_URL" ]; then
            echo "No ALERT_WEBHOOK_URL secret configured; skipping alert"
            exit 0
          fi
          MESSAGE="‚ö†Ô∏è Health Check Failed! Internal: ${INTERNAL_FAILED:-false}, External: ${EXTERNAL_FAILED:-false} | Repo: $GITHUB_REPOSITORY | Run: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
          curl -fsS -X POST -H "Content-Type: application/json" -d "{\"content\":\"$MESSAGE\"}" "$WEBHOOK_URL" || true