name: External API Diagnosis

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"  # تشغيل كل ساعة - عدّلها إذا أردت

jobs:
  diagnose-external-api:
    runs-on: ubuntu-latest

    env:
      EXTERNAL_API_URL: ${{ secrets.EXTERNAL_API_URL }}
      EXTERNAL_API_KEY: ${{ secrets.EXTERNAL_API_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install httpx

      - name: Show basic debug info
        run: |
          echo "Running External API Diagnosis..."
          echo "Current time: $(date -u)"
          echo "Repository: $GITHUB_REPOSITORY"
          echo "Workflow: $GITHUB_WORKFLOW"
          echo "API URL (masked): ${EXTERNAL_API_URL%%\?*}"

      - name: Diagnose external API
        id: diagnose
        run: |
          python << 'PYCODE'
          import os, sys, time
          import httpx

          api_url = os.getenv("EXTERNAL_API_URL")
          api_key = os.getenv("EXTERNAL_API_KEY")

          if not api_url:
              print("[ERROR] EXTERNAL_API_URL is not set (secret missing).")
              sys.exit(1)

          if not api_key:
              print("[WARN] EXTERNAL_API_KEY is not set. Trying without API key...")

          headers = {}
          if api_key:
              headers["Authorization"] = f"Bearer {api_key}"

          timeout = httpx.Timeout(10.0, connect=5.0)
          try:
              with httpx.Client(timeout=timeout, follow_redirects=True) as client:
                  response = client.get(api_url, headers=headers)
                  print(f"[INFO] Status code: {response.status_code}")
                  print(f"[INFO] Response headers: {dict(response.headers)}")

                  # اقتصار الـ body على أول 500 حرف لعدم تدمير الـ logs
                  text_preview = response.text[:500].replace("\n", " ") if response.text else ""
                  print(f"[INFO] Response body (preview): {text_preview!r}")

                  if response.status_code >= 500:
                      print("[ERROR] Server-side error from external API.")
                      sys.exit(2)
                  elif response.status_code >= 400:
                      print("[ERROR] Client-side error (check auth, URL, params).")
                      sys.exit(3)
                  else:
                      print("[SUCCESS] External API is reachable and responding OK.")
          except httpx.RequestError as exc:
              print(f"[ERROR] Request error while calling {exc.request.url!r}: {exc}")
              sys.exit(4)
          except Exception as exc:
              print(f"[ERROR] Unexpected exception: {exc}")
              sys.exit(5)
          PYCODE

      - name: Mark job result
        if: failure()
        run: |
          echo "External API diagnosis failed. Check logs above for details."
          exit 1

      - name: Mark job success
        if: success()
        run: |
          echo "External API diagnosis succeeded."
