name: 'CI: Build, Test & Lint'

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # --- Rust Job ---
  build-test-rust:
    runs-on: ubuntu-latest
    name: 'Rust: Build & Test'
    
    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v4

      - name: 'Setup Rust Toolchain'
        uses: actions/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: 'Run Cargo Check'
        working-directory: ./core
        run: cargo check

      - name: 'Run Cargo Test'
        working-directory: ./core
        run: cargo test --no-fail-fast

  # --- Node.js Job ---
  build-test-node:
    runs-on: ubuntu-latest
    name: 'Node.js: Build & Test'
    
    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v4

      - name: 'Setup Node.js Environment'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: services/api/package-lock.json

      - name: 'Install Dependencies'
        working-directory: ./services/api
        run: npm install

      # - name: 'Run Build'
      #   working-directory: ./services/api
      #   run: npm run build --if-present

      - name: 'Run Tests'
        working-directory: ./services/api
        run: npm test --if-present

  # --- Python Job ---
  lint-python:
    runs-on: ubuntu-latest
    name: 'Python: Lint'
    
    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v4

      - name: 'Setup Python Environment'
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: 'Install Dependencies'
        run: |
          python -m pip install --upgrade pip
          pip install flake8
          # if [ -f adapters/python/requirements.txt ]; then pip install -r adapters/python/requirements.txt; fi
      
      - name: 'Run Flake8 Linter'
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics